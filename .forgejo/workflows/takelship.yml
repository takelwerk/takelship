---
name: takelship

on:
  push:
  workflow_dispatch:

jobs:
  takelship:
    runs-on: takelbuild
    container:
      volumes:
        - takelbuild:/home/takelbuild
    steps:
      - name: Check out repository
        run: |
          git clone http://forgejo-server:3000/takelwerk/takelship.git /$RUNNER_TEMP/checkout
          rsync -a /$RUNNER_TEMP/checkout/ .

      - name: Link project directory
        run: ln -s $PWD /project

      - name: Lint ruby
        run: rake rubylint

      - name: Lint project
        run: rake images:project:registry:molecule:lint

      - name: Interrupt workflow
        run: |
          touch /$RUNNER_TEMP/delete_me_to_continue_workflow
          while [ -f /$RUNNER_TEMP/delete_me_to_continue_workflow ]; do sleep 1; done

      - name: Build takelage project image with packer
        run: rake images:project:build

      - name: Test takelship project registry
        run: rake images:project:registry:molecule:test

      - name: Test takelship project forgejo
        run: rake images:project:forgejo:molecule:test
