{{ takel_ship_scripts_shebang }}

# This files replaces the default ports
# in the env-docker environment files
# of each service of the {{ takel_ship_compose_project['name'] }} project
# with the ports of the ship cli configuration

SERVICES_DIR={{ takel_ship_compose_home_dir }}/{{ takel_ship_compose_dist_dir }}/{{ takel_ship_compose_compose_dir }}/{{ takel_ship_compose_services_dir }}

{% for service in takel_ship_compose_project['services'] %}
{% for port in service['ports'] | default([]) %}
SHIP_PORT=$TAKELSHIP_SHIP_PORTS_{{ service['name'] | upper | replace('-', '_') }}_{{ port['protocol'] | upper }}_{{ port['port'] | upper }}
ENV_VAR_PORT=TAKELSHIP_{{ service['name'] | upper | replace('-', '_') }}_{{ port['protocol'] | upper }}_{{ port['port'] | upper }}
if [ -n "${SHIP_PORT}" ]; then
  ENV_FILE=$SERVICES_DIR/{{ service['name'] }}/{{ takel_ship_compose_env_docker }}
  sed -i s"/^.*$ENV_VAR_PORT.*$/$ENV_VAR_PORT=$SHIP_PORT/" $ENV_FILE
fi
{% endfor %}
{% endfor %}
