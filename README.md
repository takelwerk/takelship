# takelship

*takelship* is a podman container runtime environment for docker with batteries included.

## Framework Versions

| Project | Artifacts |
|-|-|
| [![takelage-doc](https://img.shields.io/badge/github-takelage--doc-purple)](https://github.com/takelwerk/takelage-doc) | [![License](https://img.shields.io/badge/license-GNU_GPLv3-blue)](https://github.com/takelwerk/takelage-doc/blob/main/LICENSE) |
| [![takelage-var](https://img.shields.io/badge/github-takelage--var-purple)](https://github.com/takelwerk/takelage-var) | [![pypi,org](https://img.shields.io/pypi/v/pytest-takeltest?label=pypi.org&color=blue)](https://pypi.org/project/pytest-takeltest/) |
| [![takelage-cli](https://img.shields.io/badge/github-takelage--cli-purple)](https://github.com/takelwerk/takelage-cli) | [![rubygems.org](https://img.shields.io/gem/v/takeltau?label=rubygems.org&color=blue)](https://rubygems.org/gems/takeltau) |
| [![takelage-img-takelslim](https://img.shields.io/badge/github-takelage--img--takelslim-purple)](https://github.com/takelwerk/takelage-img-takelslim) | [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelslim/latest-amd64?label=hub.docker.com&arch=amd64&color=teal)](https://hub.docker.com/r/takelwerk/takelslim) [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelslim/latest-arm64?label=hub.docker.com&arch=arm64&color=slateblue)](https://hub.docker.com/r/takelwerk/takelslim) | 
| [![takelage-img-takelbase](https://img.shields.io/badge/github-takelage--img--takelbase-purple)](https://github.com/takelwerk/takelage-img-takelbase) | [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelbase/latest-amd64?label=hub.docker.com&arch=amd64&color=teal)](https://hub.docker.com/r/takelwerk/takelbase) [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelbase/latest-arm64?label=hub.docker.com&arch=arm64&color=slateblue)](https://hub.docker.com/r/takelwerk/takelbase) |
| [![takelage-img-takelpodslim](https://img.shields.io/badge/github-takelage--img--takelpodslim-purple)](https://github.com/takelwerk/takelage-img-takelpodslim) | [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelpodslim/latest-amd64?label=hub.docker.com&arch=amd64&color=teal)](https://hub.docker.com/r/takelwerk/takelpodslim) [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelpodslim/latest-arm64?label=hub.docker.com&arch=arm64&color=slateblue)](https://hub.docker.com/r/takelwerk/takelpodslim) | 
| [![takelage-img-takelpodbase](https://img.shields.io/badge/github-takelage--img--takelpodbase-purple)](https://github.com/takelwerk/takelage-img-takelpodbase) | [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelpodbase/latest-amd64?label=hub.docker.com&arch=amd64&color=teal)](https://hub.docker.com/r/takelwerk/takelpodbase) [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelpodbase/latest-arm64?label=hub.docker.com&arch=arm64&color=slateblue)](https://hub.docker.com/r/takelwerk/takelpodbase) | 
| [![takelage-dev](https://img.shields.io/badge/github-takelage--dev-purple)](https://github.com/takelwerk/takelage-dev) | [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelage/latest-amd64?label=hub.docker.com&arch=amd64&sort=semver&color=teal)](https://hub.docker.com/r/takelwerk/takelage) [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelage/latest-arm64?label=hub.docker.com&arch=arm64&sort=semver&color=slateblue)](https://hub.docker.com/r/takelwerk/takelage) |
| [![takelage-pad](https://img.shields.io/badge/github-takelage--pad-purple)](https://github.com/takelwerk/takelage-pad) | [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelpad/latest-amd64?label=hub.docker.com&arch=amd64&sort=semver&color=teal)](https://hub.docker.com/r/takelwerk/takelpad) [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelpad/latest-arm64?label=hub.docker.com&arch=arm64&sort=semver&color=slateblue)](https://hub.docker.com/r/takelwerk/takelpad) |
| [![takelship](https://img.shields.io/badge/github-takelship-purple)](https://github.com/takelwerk/takelship) | [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelship/latest-amd64?label=hub.docker.com&arch=amd64&sort=semver&color=teal)](https://hub.docker.com/r/takelwerk/takelship) [![hub.docker.com](https://img.shields.io/docker/v/takelwerk/takelship/latest-arm64?label=hub.docker.com&arch=arm64&sort=semver&color=slateblue)](https://hub.docker.com/r/takelwerk/takelship) | |


## Framework Status

| Project | Pipelines |
|-|-|
| [![takelage-var](https://img.shields.io/badge/github-takelage--var-purple)](https://github.com/takelwerk/takelage-var) | [![takeltest](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-var/takeltest.yml?label=takeltest)](https://github.com/takelwerk/takelage-var/actions/workflows/takeltest.yml) [![test_takeltest](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-var/test_takeltest.yml?label=test%20takeltest)](https://github.com/takelwerk/takelage-var/actions/workflows/test_takeltest.yml) |
| [![takelage-cli](https://img.shields.io/badge/github-takelage--cli-purple)](https://github.com/takelwerk/takelage-cli) | [![takeltau](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-cli/takeltau.yml?label=takeltau)](https://github.com/takelwerk/takelage-cli/actions/workflows/takeltau.yml) [![test_takeltau](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-cli/test_takeltau.yml?label=test%20takeltau)](https://github.com/takelwerk/takelage-cli/actions/workflows/test_takeltau.yml) |
| [![takelage-img-takelslim](https://img.shields.io/badge/github-takelage--img--takelslim-purple)](https://github.com/takelwerk/takelage-img-takelslim) | [![takelslim amd64](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-img-takelslim/takelslim_amd64.yml?label=takelslim%20amd64)](https://github.com/takelwerk/takelage-img-takelslim/actions/workflows/takelslim_amd64.yml) |
| [![takelage-img-takelbase](https://img.shields.io/badge/github-takelage--img--takelbase-purple)](https://github.com/takelwerk/takelage-img-takelbase) | [![takelbase amd64](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-img-takelbase/takelbase_amd64.yml?label=takelbase%20amd64)](https://github.com/takelwerk/takelage-img-takelbase/actions/workflows/takelbase_amd64.yml) | 
| [![takelage-img-takelpodslim](https://img.shields.io/badge/github-takelage--img--takelpodslim-purple)](https://github.com/takelwerk/takelage-img-takelpodslim) | [![takelpodslim amd64](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-img-takelpodslim/takelpodslim_amd64.yml?label=takelpodslim%20amd64)](https://github.com/takelwerk/takelage-img-takelpodslim/actions/workflows/takelpodslim_amd64.yml) |
| [![takelage-img-takelpodbase](https://img.shields.io/badge/github-takelage--img--takelpodbase-purple)](https://github.com/takelwerk/takelage-img-takelpodbase) | [![takelpodbase amd64](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-img-takelpodbase/takelpodbase_amd64.yml?label=takelpodbase%20amd64)](https://github.com/takelwerk/takelage-img-takelpodbase/actions/workflows/takelpodbase_amd64.yml) | 
| [![takelage-dev](https://img.shields.io/badge/github-takelage--dev-purple)](https://github.com/takelwerk/takelage-dev) | [![takelage amd64](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-dev/takelage_amd64.yml?label=takelage%20amd64)](https://github.com/takelwerk/takelage-dev/actions/workflows/takelage_amd64.yml) [![test_takelage](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-dev/test_takelage.yml?label=test%20takelage)](https://github.com/takelwerk/takelage-dev/actions/workflows/test_takelage.yml) 
| | [![takelbuild amd64](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-dev/takelbuild_amd64.yml?label=takelbuild%20amd64)](https://github.com/takelwerk/takelage-dev/actions/workflows/takelbuild_amd64.yml) [![test_takelbuild](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-dev/test_takelbuild.yml?label=test%20takelbuild)](https://github.com/takelwerk/takelage-dev/actions/workflows/test_takelbuild.yml) |
| | [![takelbeta amd64](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-dev/takelbeta_amd64.yml?label=takelbeta%20amd64)](https://github.com/takelwerk/takelage-dev/actions/workflows/takelbeta_amd64.yml) [![test_roles](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-dev/test_roles.yml?label=test%20roles)](https://github.com/takelwerk/takelage-dev/actions/workflows/test_roles.yml) |
| [![takelage-pad](https://img.shields.io/badge/github-takelage--pad-purple)](https://github.com/takelwerk/takelage-pad) | [![takelpad docker](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-pad/takelpad_docker.yml?label=takelpad%20docker)](https://github.com/takelwerk/takelage-pad/actions/workflows/takelpad_docker.yml) |
| | [![test takelpad](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-pad/test_takelpad.yml?label=test%20takelpad)](https://github.com/takelwerk/takelage-pad/actions/workflows/test_takelpad.yml) [![test roles](https://img.shields.io/github/actions/workflow/status/takelwerk/takelage-pad/test_roles.yml?label=test%20roles)](https://github.com/takelwerk/takelage-pad/actions/workflows/test_roles.yml) |
| [![takelship](https://img.shields.io/badge/github-takelship-purple)](https://github.com/takelwerk/takelship) | [![takelship docker](https://img.shields.io/github/actions/workflow/status/takelwerk/takelship/takelship-amd64.yml?label=takelship%20docker)](https://github.com/takelwerk/takelship/actions/workflows/takelship-amd64.yml) |

## Introduction

The takelship project is a general purpose framework to ship complex software setups. It does not ship the software itself but the configuration and the runtime environment.

The configuration and data is stored in the `takelship` directory. It is created when running `ship start [<project>]`. If a project name is omitted, the default project of the takelship is started which is a forgejo server with three runners and an apt proxy.

The `ship` command line tool is „directory-aware“ in the sense that it starts one takelship per directory. It depends on the directory which takelship `ship` is talking to, use `--workdir` or `-w` to specify a different directory. Run `ship ls` to see all takelships and their directories.

Every directory can host a different project. You can start the same project multiple times by starting them from different directories. `ship` can be configured via environment variables or a `takelage.yml` next to the `takelship` directory. See `tau config` for available configuration keys.

These basic conditions yield some amazing advantages:
- Moderate prerequisites to run a takelship: basically docker and ruby.
- Very moderate changes to the system: one directory per project and one takelship container on the docker host.
- Complete isolation between takelship projects in different directories which do do not pollute your docker host environment.
- User friendly command line interface (`ship`) with sane defaults (following the [convention over configuration](https://en.wikipedia.org/wiki/Convention_over_configuration) pradigm).
- Still *takelage* is highly customisable, transparent, free and open source software. Build your own takelship and ship arbitrarily complex software setups!
- Well-known tools for easy backup (`cp`), versioning (`git`), update (`docker pull`), migration (`rsync`) and uninstallation (`rm`) of the configuration and project data are readily available.
- Fallback mode if the takelship sinks: run the `docker-compose-up` bash script to start the project *on your host computer*. Continue to use your configured takelship project data with no takelship involved.
- If we forget about the takelship and make the fallback mode the new default then `ship` becomes a `docker-compose` generator with preconfigured data.

## Prerequisites

You need Docker (Desktop or Engine) on the host to run a takelship. You have to run docker as user, not as root. It is not possible to run the takelship container with podman although (or because?) it uses itself podman to run containers.

At the moment, these setups have been tested:
- [Docker Engine for Linux (Debian)](https://docs.docker.com/engine/install/debian/) (amd64 and arm64)
- [Docker Desktop for Linux (Debian)](https://docs.docker.com/desktop/install/linux/debian/) (amd64)
- [Docker Desktop for macOS](https://docs.docker.com/desktop/install/mac-install/) (arm64)

If you want to use the `ship` command line tool (which is a wrapper for `tau ship`) then you need Ruby and the 
[*takeltau*](https://github.com/takelwerk/takelage-cli) gem which can be installed like this:

```bash
gem install takeltau
```

## Update

To update the `ship` command line tool run

```bash
gem update
```

To update the `takelwerk/takelship` docker container run

```bash
ship update
```

To update the docker compose configuration of a takelship project just `ship start` it normally or run

```bash
ship project update
```

## Bash Completion

Add this to your [bash startup files](https://www.gnu.org/software/bash/manual/html_node/Bash-Startup-Files.html):

```bash
source <(ship completion bash)
```

## Usage

List takelships:

```bash
ship list
```

List available projects:

```bash
ship project list
```

Start a project:

```bash
ship start [<project>]
```

Stop a project:

```bash
ship stop
```

Afterwards, you can omit the project name:

```bash
ship start
```

A takelship project consists of a directory containing a `takelage.yml` configuration file a `takelship` data directory next to it. So it's one directory including everything: configuration, data and the images in the `cache` directory.

In the `takelship` directory you will find a `cache` directory. This is where the internal registry stores the downloaded docker images. It can be become huge, e.g. if you run `ship start all`.

The `ship start` command stores the `ship_default_project` as well as the current port configuration in the `takelage.yml`.

If you like nautical language you can also use `ship sail` (for `ship start`), `ship board` (for `ship login`) and `ship wreck` (for `ship stop`).

## Example: project forgejo

We can start the project forgejo to start a [Forgejo](https://forgejo.org/) build server and three runners, an [Apt Proxy](https://github.com/soulteary/apt-proxy) and a [Portainer CE](https://docs.portainer.io/) container management web interface like this:

```
~/takelshiptest$ ship start forgejo
The takelship takelship_xitet-folal
departed from ~/takelshiptest
ships project forgejo

localhost:50600 [docker-host docker]      (DOCKER_HOST=tcp://localhost:50600)
localhost:60261 [takelship-registry http]
localhost:56628 [forgejo-server http]     (administrator/administrator)
localhost:47015 [forgejo-server ssh]
localhost:57509 [aptproxy-server http]
```

When you run `ship start forgejo` in a directory for the first time, the `ship` cli queries the `takelwerk/takelship` container about the project. (It exposes the result via `ship info takelship` and notes it down in the file `takelship/takelship.yml`.)

Now that `ship` knows about the internal port configuration of the project it can dynamically choose free local ports on your host system. It notes the configuration down in the `takelship.yml` and will use it the next time you start the project: 

```
---
ship_default_project: forgejo
ship_ports_aptproxy_server_http_33142: 57509
ship_ports_docker_host_docker_32375: 50600
ship_ports_forgejo_server_http_33000: 56628
ship_ports_forgejo_server_ssh_30022: 47015
ship_ports_takelship_registry_http_5555: 60261
```

If you don't like the port configuration then change it by editing the `takelage.yml` configuration file. Afterwards restart the takelship to activate the new configuration:

```bash
ship restart
```

Maybe you'll end up with something like this:

```
---
ship_default_project: forgejo
ship_ports_aptproxy_server_http_33142: 3142
ship_ports_docker_host_docker_32375: 3375
ship_ports_forgejo_server_http_33000: 3000
ship_ports_forgejo_server_ssh_30022: 3022
ship_ports_takelship_registry_http_5555: 3555
```

You can disable a port by setting it to `0` or nothing:

```bash
ship_ports_aptproxy_server_http_33142: 0
ship_ports_docker_host_docker_32375:
```

If you want `ship` to choose a new port configuration then delete one ore more config lines. When you change a port, all configuration scripts are updated the next time a takelship is started.

Just be sure to leave the `ship_default_project` in the `takelage.yml` or you'll end up with forgejo and its runners (which is the takelship default project) and a *preconfigured* `docker compose` project ready to run on your host. But maybe that's exactly what you want...

## forgejo docker compose project

When you start a takelship forgejo project some pretty complex things happen. The 
[server preinstallation](https://github.com/takelwerk/takelship/blob/main/ansible/roles/takel_ship_forgejo/templates/run-preinstall.forgejo-server.bash.j2), the
[server postinstallation](https://github.com/takelwerk/takelship/blob/main/ansible/roles/takel_ship_forgejo/templates/run-postinstall.forgejo-server.bash.j2) and the
[runner preinstallation](https://github.com/takelwerk/takelship/blob/main/ansible/roles/takel_ship_forgejo/templates/run-preinstall.forgejo-runner.bash.j2) is done in the takelship but the configuration and the data end up in the `takelship` directory on your host. From here, you can run it *on your host* with `docker compose`.

The configuration for `podman-compose` which is used in the takelship differs slightly from the `docker-compose` one on your host. For example, the port configuration is probably different than the default configuration in the takelship.

The solution to this problem are `docker-env` files for each service:

```bash
takelship/compose/services/<service-name>/docker-env
```

There is a `docker compose` run script `docker-compose-up` for each project which includes those env-files:

```bash
takelship/compose/projects/forgejo/docker-compose-up
```

It will also start the takelship registry service so that you have access to your already downloaded docker images of the project.

Run the `docker-compose-down` script to stop the forgejo project and the takelship registry:

```bash
takelship/compose/projects/forgejo/docker-compose-down
```

You have used the takelship as a one-time command to create and preconfigure a `docker compose` project. Used this way, `ship` becomes a `docker compose` project generator.

## tea command line tool

You can find a preconfigured [tea](https://gitea.com/gitea/tea) configuration file in the forgejo server project:

```bash
takelship/compose/projects/forgejo-server/config.yml
```

This file can be symlinked as your host tea configuration file:
- Linux: `~/.config/tea/config.yml`
- macOS: `~/Library/Application\ Support/tea/config.yml`

## takelship without ship

Get info how to run a takelship project:

```
$ docker run -it --rm takelwerk/takelship
[takelship] This is a takelwerk takelship container
[takelship] Image: takelwerk/takelship:0.1.101
[takelship] Info: https://github.com/takelwerk/takelship
[takelship] CLI: https://github.com/takelwerk/takelage-cli
[takelship] No project selected. Available projects:

== Project: all
= All services of all projects.
docker run --rm --interactive --tty --name takelship --hostname takelship --privileged --publish "127.0.0.1:32375:32375" --publish "127.0.0.1:33142:33142" --publish "127.0.0.1:39000:39000" --publish "127.0.0.1:35000:35000" --publish "127.0.0.1:35080:35080" --publish "127.0.0.1:33000:33000" --publish "127.0.0.1:30022:30022" --publish "127.0.0.1:38111:38111" --volume ./takelship:/home/podman/takelship takelwerk/takelship all

== Project: aptproxy
= APT Proxy (github.com/soulteary/apt-proxy) Provides package caching.
docker run --rm --interactive --tty --name takelship --hostname takelship --privileged --publish "127.0.0.1:32375:32375" --publish "127.0.0.1:33142:33142" --volume ./takelship:/home/podman/takelship takelwerk/takelship aptproxy

== Project: registry
= Docker registry (distribution.github.io/distribution). Registry UI (github.com/quiq/registry-ui). Provides image hosting. Provides Docker registry web interface.
docker run --rm --interactive --tty --name takelship --hostname takelship --privileged --publish "127.0.0.1:32375:32375" --publish "127.0.0.1:35000:35000" --publish "127.0.0.1:35080:35080" --volume ./takelship:/home/podman/takelship takelwerk/takelship registry

== Project: forgejo
= Forgejo Gitea fork (forgejo.org). Provides git hosting. Provides CI/CD pipelines (GitHub style). Provides image hosting. Runs with Forgejo Runners. Runs with Portainer. Runs with Docker in Docker.
docker run --rm --interactive --tty --name takelship --hostname takelship --privileged --publish "127.0.0.1:32375:32375" --publish "127.0.0.1:33000:33000" --publish "127.0.0.1:30022:30022" --publish "127.0.0.1:39000:39000" --volume ./takelship:/home/podman/takelship takelwerk/takelship forgejo

== Project: teamcity
= TeamCity build server (jetbrains.com/teamcity). Provides CI/CD pipelines (JetBrains style). Runs with TeamCity Runners. Runs with Forgejo and its runners. Runs with Portainer. Runs with Docker in Docker.
docker run --rm --interactive --tty --name takelship --hostname takelship --privileged --publish "127.0.0.1:32375:32375" --publish "127.0.0.1:33000:33000" --publish "127.0.0.1:30022:30022" --publish "127.0.0.1:38111:38111" --publish "127.0.0.1:39000:39000" --volume ./takelship:/home/podman/takelship takelwerk/takelship teamcity
```

List available container commands:

```bash
docker exec -it takelship cli
```

Which gives

```
takelship command line interface:

== cli
= List available commands.

== pod
= Run as podman user.

== compose-nonroot
= Run nonroot podman-compose.

== forgejo
= Forgejo admin command line interface.
```

Run a command as podman user:

```bash
docker exec -it takelship pod podman ps -a
```

Alternatively, get the same result using docker on your host:

```bash
DOCKER_HOST=tcp://localhost:32375 docker ps
```

Run a command as podman user in a different directory (`-w` or `--workdir`) than the default directory (`/home/podman`):

```bash
docker exec -it takelship pod -w /tmp "podman info > ./podman_info"
docker exec -it takelship pod cat /tmp/podman_info
```

Enter a login shell as podman user:

```bash
docker exec -it takelship pod shell
```

Become root:

```bash
docker exec -it takelship bash
```

## Languages, libraries and tools

The *takelship* project is written in five different languages:

- [Ansible](https://ansible.readthedocs.io/) (provisioning, compile time)
- [Jinja2](https://jinja.palletsprojects.com) (templating, compile time)
- [Python](https://www.python.org/) (testing, compile time)
- [Bash](https://www.gnu.org/software/bash/) (scripting, runtime)
- [Ruby](https://www.ruby-lang.org/) (cli, runtime)

Ansible is well suited for building complex machines like a takelship. We use [molecule](https://ansible.readthedocs.io/projects/molecule/) to create and test the ansible code. Then [packer](https://www.packer.io/) builds the docker image which is then tested in Python by using [testinfra](https://testinfra.readthedocs.io/) and [takeltest](https://github.com/takelwerk/takelage-var).

We use Jinja2 to create configuration files and bash scripts in the takelship. They will be run each time the takelship starts. We favour many simple bash scripts over a few complex ones. But you can't always get what you want.

The command line tool is written in Ruby because Ruby makes programmers happy.

Don't run this in production. It's meant to be hacked.
